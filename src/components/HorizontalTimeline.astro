---
import SectionTitle from './SectionTitle.astro';
import { getTimelineEntries, formatTimelineDate } from '../utils/timeline';

const timelineEntries = await getTimelineEntries();
---

<section
	id="timeline"
	class="section timeline-horizontal scroll-panel flex min-h-screen w-full items-start justify-start"
	data-timeline-entries={timelineEntries.length}
>
	<div class="container">
		<SectionTitle number="05" title="Journey Timeline" />
		
		<div class="timeline-container">
			<!-- Timeline Track -->
			<div class="timeline-track">
				<div class="timeline-progress" id="timeline-progress"></div>
				<div class="timeline-points">
					{timelineEntries.map((entry, index) => (
						<div
							class="timeline-point"
							data-index={index}
							data-year={entry.date}
						>
							<div class="point-marker">
								<div class="point-icon">{entry.icon}</div>
								<div class="point-ring"></div>
							</div>
							<span class="point-year">{formatTimelineDate(entry.date)}</span>
						</div>
					))}
				</div>
			</div>

			<!-- Content Display Area -->
			<div class="timeline-content-wrapper">
				{timelineEntries.map((entry, index) => {
					const EntryContent = entry.Content;
					return (
						<div
							class="timeline-content-panel"
							data-index={index}
						>
							<div class="content-header">
								<div class="content-meta">
									<span class="content-category">{entry.category}</span>
									<span class="content-date">{formatTimelineDate(entry.date)}</span>
								</div>
								<h2 class="content-title">{entry.title}</h2>
							</div>
							<div class="content-body">
								{EntryContent && <EntryContent />}
							</div>
						</div>
					);
				})}
			</div>
		</div>
	</div>
</section>

<style>
	.timeline-horizontal {
		background: var(--bg-secondary);
		position: relative;
		overflow: visible;
	}

	.timeline-container {
		position: relative;
		padding: 3rem 0 6rem;
		min-height: 200vh; /* Increased height for more scroll distance */
	}

	/* Timeline Track */
	.timeline-track {
		position: sticky;
		top: 80px;
		width: 100%;
		height: 120px;
		margin-bottom: 4rem;
		display: flex;
		align-items: center;
		z-index: 10;
	}

	.timeline-progress {
		position: absolute;
		left: 0;
		top: 50%;
		transform: translateY(-50%);
		height: 2px;
		width: 0%;
		background: var(--accent-primary);
		transition: width 0.1s linear;
		z-index: 1;
	}

	.timeline-points {
		position: relative;
		width: 100%;
		display: flex;
		justify-content: space-between;
		align-items: center;
		z-index: 2;
		padding: 0 2rem;
	}

	.timeline-point {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.75rem;
		transition: all 0.3s ease;
		pointer-events: none;
	}

	.point-marker {
		position: relative;
		width: 60px;
		height: 60px;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: transform 0.3s ease;
	}

	.point-icon {
		width: 60px;
		height: 60px;
		background: var(--bg-tertiary);
		border: 3px solid var(--accent-primary);
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.75rem;
		position: relative;
		z-index: 2;
		transition: all 0.3s ease;
		box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
		opacity: 0.5;
	}

	.timeline-point.active .point-icon {
		opacity: 1;
		background: var(--gradient-primary);
		box-shadow: 0 0 30px rgba(99, 102, 241, 0.6);
		transform: scale(1.2);
		border-color: var(--accent-secondary);
	}

	.timeline-point.passed .point-icon {
		opacity: 1;
		background: var(--accent-primary);
		border-color: var(--accent-primary);
	}

	.point-ring {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 80px;
		height: 80px;
		border: 2px solid var(--accent-primary);
		border-radius: 50%;
		opacity: 0;
		z-index: 1;
		transition: opacity 0.3s ease;
	}

	.timeline-point.active .point-ring {
		opacity: 0.6;
		animation: pulse-ring 2s ease-in-out infinite;
	}

	.point-year {
		font-size: 0.875rem;
		font-weight: 600;
		color: var(--text-secondary);
		transition: color 0.3s ease;
		font-family: 'Courier New', monospace;
		white-space: nowrap;
	}

	.timeline-point.active .point-year {
		color: var(--text-primary);
		font-weight: 700;
	}

	.timeline-point.passed .point-year {
		color: var(--accent-primary);
	}

	@keyframes pulse-ring {
		0%, 100% {
			transform: translate(-50%, -50%) scale(1);
			opacity: 0.6;
		}
		50% {
			transform: translate(-50%, -50%) scale(1.2);
			opacity: 0.3;
		}
	}

	/* Content Display */
	.timeline-content-wrapper {
		position: relative;
		min-height: 600px;
	}

	.timeline-content-panel {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		opacity: 0;
		transform: translateY(30px);
		pointer-events: none;
		transition: opacity 0.6s ease, transform 0.6s ease;
	}

	.timeline-content-panel.active {
		opacity: 1;
		transform: translateY(0);
		pointer-events: all;
	}

	.content-header {
		margin-bottom: 2rem;
		padding-bottom: 1.5rem;
		border-bottom: 1px solid var(--border-color);
	}

	.content-meta {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
		flex-wrap: wrap;
	}

	.content-category {
		font-size: 0.875rem;
		color: var(--text-secondary);
		background: var(--bg-tertiary);
		padding: 0.375rem 1rem;
		border-radius: 20px;
		border: 1px solid var(--border-color);
		text-transform: capitalize;
	}

	.content-date {
		font-size: 0.875rem;
		color: var(--accent-primary);
		font-weight: 400;
		font-family: 'JetBrains Mono', 'Menlo', 'Consolas', monospace;
	}

	.content-title {
		font-size: clamp(2rem, 4vw, 3rem);
		font-weight: 700;
		background: var(--gradient-primary);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
		line-height: 1.2;
		margin: 0;
	}

	.content-body {
		color: var(--text-secondary);
		line-height: 1.8;
		font-size: 1.125rem;
	}

	.content-body :global(p) {
		margin-bottom: 1.5rem;
	}

	.content-body :global(h2),
	.content-body :global(h3) {
		color: var(--text-primary);
		margin-top: 2rem;
		margin-bottom: 1rem;
		font-size: 1.5rem;
		font-weight: 600;
	}

	.content-body :global(h2:first-child),
	.content-body :global(h3:first-child) {
		margin-top: 0;
	}

	.content-body :global(ul),
	.content-body :global(ol) {
		margin-left: 2rem;
		margin-bottom: 1.5rem;
	}

	.content-body :global(li) {
		margin-bottom: 0.75rem;
	}

	.content-body :global(strong) {
		color: var(--text-primary);
		font-weight: 600;
	}

	/* Responsive Design */
	@media (max-width: 1024px) {
		.timeline-track {
			top: 100px;
		}

		.timeline-points {
			padding: 0 1rem;
		}

		.point-icon {
			width: 50px;
			height: 50px;
			font-size: 1.5rem;
		}

		.point-marker {
			width: 50px;
			height: 50px;
		}

		.point-ring {
			width: 70px;
			height: 70px;
		}
	}

	@media (max-width: 768px) {
		.timeline-track {
			height: 100px;
			margin-bottom: 3rem;
			top: 80px;
		}

		.timeline-points {
			overflow-x: auto;
			scroll-snap-type: x mandatory;
			-webkit-overflow-scrolling: touch;
			padding-bottom: 1rem;
			scrollbar-width: none;
		}

		.timeline-points::-webkit-scrollbar {
			display: none;
		}

		.timeline-point {
			flex-shrink: 0;
			scroll-snap-align: center;
			min-width: 80px;
		}

		.point-icon {
			width: 45px;
			height: 45px;
			font-size: 1.25rem;
		}

		.point-marker {
			width: 45px;
			height: 45px;
		}

		.point-year {
			font-size: 0.75rem;
		}

		.timeline-content-wrapper {
			min-height: 500px;
		}

		.content-title {
			font-size: 1.75rem;
		}

		.content-body {
			font-size: 1rem;
		}
	}

	@media (max-width: 480px) {
		.timeline-point {
			min-width: 70px;
		}

		.point-icon {
			width: 40px;
			height: 40px;
			font-size: 1rem;
		}

		.point-marker {
			width: 40px;
			height: 40px;
		}
	}
</style>

<script>
	const progressBar = document.getElementById('timeline-progress');
	const timelinePoints = document.querySelectorAll('.timeline-point');
	const contentPanels = document.querySelectorAll('.timeline-content-panel');

	const totalEntries = timelinePoints.length;
	let currentActiveIndex = 0;

	function updateTimeline(progress) {
		// Clamp progress between 0 and 1
		const clamped = Math.max(0, Math.min(1, progress));

		// Calculate which entry should be active
		// Use a smoother threshold-based approach to prevent rapid switching
		// Each entry gets equal scroll time, but we add a small buffer to prevent flickering
		const segmentSize = 1 / totalEntries;
		let activeIndex = 0;
		
		// Find the active index based on progress with a small threshold
		for (let i = 0; i < totalEntries; i++) {
			const segmentStart = i * segmentSize;
			const segmentEnd = (i + 1) * segmentSize;
			// Add a small overlap threshold (5% of segment) to prevent rapid switching
			const threshold = segmentSize * 0.05;
			
			if (clamped >= segmentStart - threshold && clamped < segmentEnd) {
				activeIndex = i;
				break;
			}
		}
		
		// Ensure we don't go beyond the last entry
		activeIndex = Math.min(activeIndex, totalEntries - 1);

		// Update progress bar
		if (progressBar) {
			progressBar.style.width = `${clamped * 100}%`;
		}

		// Update timeline points with smooth transitions
		timelinePoints.forEach((point, index) => {
			point.classList.remove('active', 'passed');
			if (index < activeIndex) {
				point.classList.add('passed');
			} else if (index === activeIndex) {
				point.classList.add('active');
			}
		});

		// Update content panels - only switch when index actually changes
		if (activeIndex !== currentActiveIndex) {
			contentPanels.forEach((panel, index) => {
				panel.classList.toggle('active', index === activeIndex);
			});
			currentActiveIndex = activeIndex;
			console.log('[Timeline] Switched to entry:', activeIndex);
		}
	}

	// Default state
	updateTimeline(0);
	console.log('[Timeline] Initialized with entries:', totalEntries);

	// Listen for progress updates from the main scroll controller
	window.addEventListener('timelineprogress', (e) => {
		const detail = e.detail || {};
		if (typeof detail.progress === 'number') {
			console.log('[Timeline] Progress:', detail.progress.toFixed(3));
			updateTimeline(detail.progress);
		}
	});
</script>